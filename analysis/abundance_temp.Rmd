---
title: "Abundance"
knit: neurotransmissionevolution::custom_knit
---
```{r include=FALSE}
knitr::opts_chunk$set(
  warning     = FALSE,
  message     = FALSE,
  cache       = TRUE#,
  # cache.extra = file.mtime("download/link_pathway_entrez.tsv")
)
```

Loading initial resources:
```{r}
# Data manipulation
library(tidyverse)
library(magrittr)

# Utils
library(neurotransmissionevolution)

# Packaged data
data(
   cogs
  ,gene_ids
  ,gene_cogs
  ,string_eukaryotes
  ,package = "neurotransmissionevolution"
)

# Fresh analysis data
cog_roots                   <- read_tsv("geneplast_roots.tsv",             col_types = "ci")
clade_names                 <- read_tsv("geneplast_clade_names.tsv",       col_types = "ic")
clade_taxids                <- read_tsv("geneplast_clade_taxids.tsv",      col_types = "ici")

# Collapsing similar functions
gene_annotation <- read_tsv("../data/gene_annotation.tsv", col_types = "cc") %>%
  mutate(annotation = case_when(
     grepl("clearance",   annotation) ~ "depletion"
    ,grepl("degradation", annotation) ~ "depletion"
    ,grepl("transport",   annotation) ~ "synthesis"
    ,TRUE ~ annotation
  ))
```

A
```{r}
# If a gene has more than 1 COG, select the oldest one.
# This is unusual, but can happen in cases of gene fusion, for instance.
gene_cogs %<>%
  inner_join(cog_roots) %>%
  group_by(string_id) %>%
  filter(root == max(root))

# The function of a COG is the function of its proteins
cog_annotation <- gene_ids %>%
  inner_join(gene_cogs) %>%
  inner_join(gene_annotation) %>%
  distinct(cog_id, annotation)

# Number of proteins in a COG in every species
cog_size_by_taxid <- cogs %>%
  count(taxid, cog_id, name = "cog_size")

# Number of proteins in every species
protein_n_by_taxid <- cog_size_by_taxid %>%
  count(taxid, wt = cog_size, name = "protein_n")

# Mapping species to clade info
ordered_species <- string_eukaryotes %>%
  select(taxid, ncbi_name) %>%
  left_join(clade_taxids) %>%
  left_join(clade_names, by = c("lca" = "root")) %>%
  mutate(
     lca        = as_factor(lca) %>% fct_rev
    ,ncbi_name  = fct_reorder(ncbi_name, -taxid_order)
    ,clade_name = fct_reorder(clade_name, -taxid_order)
  )

annotation_colors <- c(
   "depletion"             = "#F40000"
  ,"excitability"          = "#FFAB00"
  ,"receptor-associated"   = "#D6EE00"
  ,"ionotropic receptor"   = "#43FF1C"
  ,"metabotropic receptor" = "#18FFFF"
  ,"signaling"             = "#0091EA"
  ,"g-protein"             = "#0033ff"
  ,"synthesis"             = "#AA00FF"
  ,"vesicle"               = "#FF00AA"
)
```

```{r}
proportion_by_function <- cog_size_by_taxid %>%
  inner_join(cog_annotation) %>%
  count(taxid, annotation, wt = cog_size, name = "annotation_count") %>%
  left_join(protein_n_by_taxid) %>%
  mutate(proportion = annotation_count / protein_n) %>%
  left_join(ordered_species)
```

```{r fig.align="center", fig.height=8, fig.width=16, fig.cap="A"}
metazoa_line <- geom_vline(
   xintercept = "Mnemiopsis leidyi"
  ,color      = "#FF0000"
  ,linetype   = "11"
  ,alpha      = 1
  ,size       = 0.25
)

ggplot(proportion_by_function) +
  ggtitle("Number of proteins in a function divided by number of all proteins in species") +
  metazoa_line +
  geom_bar(aes(x = ncbi_name, y = proportion, fill = annotation, color = annotation), stat = "identity") +
  facet_grid(annotation ~ clade_name, scales = "free", space = "free_x") +
  scale_y_continuous("Proportion of neural proteins", minor_breaks = NULL) +
  xlab("Taxa") +
  scale_fill_manual(values = annotation_colors %>% darken(0.1)) +
  scale_color_manual(values = annotation_colors %>% darken(0.2)) +
  theme(
     panel.spacing      = unit(2.5, "pt")
    ,strip.background.x = element_blank()
    ,strip.background.y = element_rect(fill="#E0E0E0")
    ,panel.grid.major.x = element_blank()
    ,panel.grid.major.y = element_line(colour = "#F5F5F5", size = 0.25)
    ,panel.background   = element_rect(fill = '#EEEEEE', colour = '#E0E0E0')
    ,strip.text.x       = element_text(size = 6, angle = 90, hjust = 0, vjust = 0.5)
    ,strip.text.y       = element_text(size = 8, vjust = 0.5)
    ,axis.text.x        = element_text(size = 2, angle = -45, vjust = 0, hjust = 0)
    ,axis.text.y        = element_text(size = 6)
    ,legend.position    = "none"
  )
ggsave("plots/fig5_raw_temp.pdf", width = 16, height = 8)
```
