---
title: "Root info"
knit: neurotransmissionevolution::custom_knit
---
```{r message=FALSE, include=FALSE}
knitr::opts_chunk$set(
  warning     = FALSE,
  message     = FALSE#,
  # cache       = TRUE,
  # cache.extra = file.mtime("download/link_pathway_entrez.tsv")
)
```

# Dados
```{r }
# Data manipulation
library(tidyverse)
library(magrittr)

# Utils
library(neurotransmissionevolution)

# Packaged data
data(
  ogr,
  gene_ids,
  gene_pathways,
  cogs_of_interest,
  string_eukaryotes,
  package = "neurotransmissionevolution"
)

# Fresh analysis data
cog_roots                   <- read_tsv("geneplast_roots.tsv",             col_types = "ci")
clade_names                 <- read_tsv("geneplast_clade_names.tsv",       col_types = "ic")
pathway_neuroexclusivity    <- read_tsv("neuroexclusivity_pathway.tsv",    col_types = "cn")
expression_neuroexclusivity <- read_tsv("neuroexclusivity_expression.tsv", col_types = "cn")

# Collapsing similar functions
gene_annotation <- read_tsv("../data/gene_annotation.tsv", col_types = "cc") %>%
  mutate(annotation = case_when(
     grepl("clearance",   annotation) ~ "depletion"
    ,grepl("degradation", annotation) ~ "depletion"
    ,grepl("transport",   annotation) ~ "synthesis"
    ,TRUE ~ annotation
  ))
```

# joining data
```{r}
# If a gene has more than 1 COG, select the oldest one.
# This is unusual, but can happen in cases of gene fusion, for instance.
gene_cogs %<>%
  inner_join(cog_roots) %>%
  group_by(string_id) %>%
  filter(root == max(root))

gene_info <- gene_ids %>%
  na.omit %>%
  inner_join(gene_cogs) %>%
  inner_join(gene_pathways) %>%
  inner_join(gene_annotation) %>%
  inner_join(pathway_neuroexclusivity) %>%
  mutate(is_neuroexclusive = pathway_neuroexclusivity >= 0.9)
```


```{r}
cumulative_emergence <- clade_names %>%
  # Adding and selecting gene info
  left_join(gene_info) %>%
  select(root, clade_name, annotation, is_neuroexclusive) %>%
  # Pivoting from wide to long
  pivot_longer(annotation:is_neuroexclusive, values_ptypes = list(value = "character")) %>%
  # Counting nodes by category (name) for each root
  count(root, clade_name, name, value) %>%
  # Making absent counts explicit
  group_by(name) %>%
  complete(nesting(root, clade_name), name, value, fill = list(n = 0)) %>%
  # No reason to include NA observations in cumulative sum
  na.omit %>%
  # Cumulative sum node count at each root
  group_by(name, value) %>%
  mutate(cumulative_count = order_by(-root, cumsum(n)))
```

```{r}
function_colors <- c(
   "depletion"             = "#F40000"
  ,"excitability"          = "#FFAB00"
  ,"receptor-associated"   = "#D6EE00"
  ,"ionotropic receptor"   = "#43FF1C"
  ,"metabotropic receptor" = "#18FFFF"
  ,"signaling"             = "#0091EA"
  ,"g-protein"             = "#0033ff"
  ,"synthesis"             = "#AA00FF"
  ,"vesicle"               = "#FF00AA"
  #-----------------------------------
  ,"TRUE"                  = "#0000FF"
  ,"FALSE"                 = "#FF0000"
)

cumulative_emergence %<>% ungroup %>%
  # Creating ordered factors for plotting
  mutate(
     clade_name = fct_reorder(clade_name, -root)
    ,value      = fct_reorder(value, name)
  )

ggplot(cumulative_emergence) +
  #----- Barplot ------
  geom_bar(
     mapping     = aes(clade_name, cumulative_count, group = value)
    ,stat        = "sum"
    ,fill        = "#999999"
    ,show.legend = F
  ) +
  #----- Lines ------
  geom_line(
     mapping = aes(clade_name, cumulative_count, group = value, color = value)
    ,size    = 1
  ) +
  #----- Styling ------
  scale_color_manual(values = function_colors) +
  facet_grid(name ~ .) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```
