---
title: "Roots plots"
knit: neurotransmissionevolution::custom_knit
---
```{r message=FALSE, include=FALSE}
knitr::opts_chunk$set(
  warning     = FALSE,
  message     = FALSE#,
  # cache       = TRUE,
  # cache.extra = file.mtime("download/link_pathway_entrez.tsv")
)
library(tidyverse)
library(magrittr)

library(treeio)
library(ggtree)
library(tidytree)
library(neurotransmissionevolution)
```

# Dados
```{r rows.print=5}
data(
  ogr,
  ogp,
  gene_ids,
  gene_pathways,
  cogs_of_interest,
  string_eukaryotes,
  package = "neurotransmissionevolution"
)

gene_annotation <- read_tsv("../data/gene_annotation.tsv", col_types = "cc") %>%
  mutate(annotation = case_when(
    grepl("clearance",annotation) ~ "depletion",
    grepl("degradation",annotation) ~ "depletion",
    grepl("transport",annotation) ~ "synthesis",
    TRUE ~ annotation
  ))

pathway_neuroexclusivity    <- read_tsv("neuroexclusivity_pathway.tsv", col_types = "cn")
expression_neuroexclusivity <- read_tsv("neuroexclusivity_expression.tsv", col_types = "cn")

cog_roots <- read_tsv("geneplast_roots.tsv", col_types = "ci")

roots_extant_clades <- read_tsv("geneplast_clade_names.tsv", col_types = "ic")
```

# joining data
```{r}
cogs_of_interest %<>% inner_join(cog_roots) %>% group_by(string_id) %>% filter(root == max(root))

info <- gene_ids %>%
  na.omit %>%
  inner_join(gene_pathways) %>%
  inner_join(pathway_neuroexclusivity) %>%
  inner_join(gene_annotation) %>%
  inner_join(cogs_of_interest) %>%
  mutate(ne = pathway_neuroexclusivity >= 0.9)
```

# wrangle
```{r}
wide_annotation <- info %>%
  mutate(n = 1) %>%
  pivot_wider(
  id_cols = root,
  names_from = annotation,
  values_from = n,
  values_fn = list(n = length),
  values_fill = list(n = 0)
)

ne_count <- info %>%
  group_by(root) %>%
  summarise(n = n(), ne = sum(ne), nne = n() - sum(ne)) %>%
  arrange(-root) %>%
  mutate_at(vars(-root), cumsum) %>%
  pivot_longer(-root, names_to = "annotation", values_to = "n")
  

annotation_cs <- wide_annotation %>%
  arrange(-root) %>%
  mutate_at(vars(-root), cumsum) %>%
  pivot_longer(-root, names_to = "annotation", values_to = "n")
```

# plot
```{r}
root_text <- roots_extant_clades %>% filter(root %in% ne_count[["root"]])

text <- geom_text(data = root_text, aes(x = root, label = clade_name, y=75), angle=90, hjust=0)
line_aes <- aes(x = root, y = n, group = annotation, color = annotation)
scale_reverse <- scale_x_reverse(breaks = seq(0, 40, by = 1), expand = c(0,0), minor_breaks = NULL)

ggplot(annotation_cs) +
  geom_line(line_aes) +
  scale_reverse +
  text
ggsave("plots/roots_function.pdf", width = 10, height = 6)

ggplot() +
  geom_bar(data = ne_count %>% filter(annotation == "n"), aes(x = root, y = n), fill = "#999999", stat = "identity") +
  geom_line(data = ne_count %>% filter(!annotation == "n"), line_aes, size = 2) +
  scale_reverse +
  text
ggsave("plots/roots_ne.pdf", width = 10, height = 6)
```

```{r message=FALSE, include=F, eval=F}
hybrid_tree <- read.newick("../data/hybrid_tree_modified.nwk")

iono_cogs <- info %>% filter(annotation == "ionotropic receptor") %>% pull(cog_id) %>% unique

tree_heatmap <- ogr@orthoct %>%
  as_tibble(rownames = NA) %>%
  select(iono_cogs)

tree_heatmap2 <- ogp@orthodist %>%
  as_tibble(rownames = NA) %>%
  select(iono_cogs)

string_eukaryotes %<>% inner_join(ogr@spbranches, by = c("taxid" = "ssp_id")) %>% rename(root = `9606`)

to_drop <- ogr@spbranches %>% filter(!`9606` %in% 29:26) %>% pull(ssp_id)

early_animals <- hybrid_tree %>%
  drop.tip(to_drop) %>%
  as_tibble %>%
  left_join(string_eukaryotes %>% select(label = taxid, ncbi_name, root)) %>%
  as.treedata
  
p <- ggtree(early_animals, branch.length = "none") +
  geom_tiplab(aes(label = ncbi_name), offset = 1, hjust = 0, align = T) +
  xlim(0,50)

gheatmap(
  p,
  tree_heatmap,
  offset=15,
  width=8,
  font.size=3,
  colnames_angle=45,
  hjust=0.25,
  low = "#DDDDDD",
  high = "#00AA44"
)
ggsave("plots/roots_ionotropic_pattern.pdf", width = 10, height = 6)

gheatmap(
  p,
  tree_heatmap2,
  offset=15,
  width=8,
  font.size=3,
  colnames_angle=45,
  hjust=0.25,
  low = "#DDDDDD",
  high = "#00AA44"
)
ggsave("plots/roots_ionotropic_abundance.pdf", width = 10, height = 6)
```

