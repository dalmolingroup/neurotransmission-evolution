---
title: "Abundances"
knit: neurotransmissionevolution::custom_knit
---
```{r message=FALSE}
library(tidyverse)
library(magrittr)

library(neurotransmissionevolution)
```

# Dados
```{r}
data(
   cogs
  ,gene_ids
  ,gene_cogs
  ,string_eukaryotes
  ,package = "neurotransmissionevolution"
)

# Fresh analysis data
cog_roots                   <- read_tsv("geneplast_roots.tsv",             col_types = "ci")
clade_names                 <- read_tsv("geneplast_clade_names.tsv",       col_types = "ic")
clade_taxids                <- read_tsv("geneplast_clade_taxids.tsv",      col_types = "ici")

# Collapsing similar functions
gene_annotation <- read_tsv("../data/gene_annotation.tsv", col_types = "cc") %>%
  mutate(annotation = case_when(
     grepl("clearance",   annotation) ~ "depletion"
    ,grepl("degradation", annotation) ~ "depletion"
    ,grepl("transport",   annotation) ~ "synthesis"
    ,TRUE ~ annotation
  ))

spbranches <- ogr@spbranches %>% select(taxid = ssp_id, root = `9606`)
```

# joining data
```{r}
# If a gene has more than 1 COG, select the oldest one.
# This is unusual, but can happen in cases of gene fusion, for instance.
gene_cogs %<>%
  inner_join(cog_roots) %>%
  group_by(string_id) %>%
  filter(root == max(root)) %>%
  inner_join(clade_names)

cog_annotation <- gene_ids %>%
  inner_join(gene_cogs) %>%
  inner_join(gene_annotation) %>%
  distinct(cog_id, annotation)

cog_size_by_taxid <- cogs %>%
  filter(cog_id %in% gene_cogs[["cog_id"]]) %>%
  count(taxid, cog_id, name = "cog_size")

cog_n_by_taxid <- cog_size_by_taxid %>%
  count(taxid, name = "cog_n")

ordered_species <- string_eukaryotes %>%
  select(taxid, ncbi_name) %>%
  left_join(clade_taxids) %>%
  mutate(ncbi_name = fct_reorder(ncbi_name, -taxid_order))
```

```{r}
cog_abundance <- cog_size_by_taxid %>%
  inner_join(cog_annotation) %>%
  group_by(taxid, annotation) %>%
  summarise(annotation_count = sum(cog_size)) %>%
  ungroup %>%
  left_join(cog_n_by_taxid) %>%
  mutate(abundance = annotation_count / cog_n) #%>%
  # left_join(clade_taxids) %>%
  # left_join(string_eukaryotes %>% select(taxid, ncbi_name))
```

```{r}
abundance_by_function <- cog_size_by_taxid %>%
  inner_join(cog_annotation) %>%
  count(taxid, annotation, wt = cog_size, name = "annotation_count") %>%
  left_join(cog_n_by_taxid) %>%
  mutate(abundance = annotation_count / cog_n)
```

```{r}
abundance_by_function %<>% left_join(ordered_species)

plot_config <- list(
  facet_grid(annotation ~ lca, scales = "free_y"),
  geom_vline(xintercept = "Mnemiopsis leidyi", color = "#FF0000", linetype = "11", size = 0.25),
  theme(axis.text.x = element_text(size = 3, angle = 90, hjust = 1, vjust = 0)),
  theme(plot.title  = element_text(size = 20, face = "bold"))
)

ggplot(abundance_by_function) +
  geom_bar(aes(x = ncbi_name, y = abundance), stat = "identity") +
  ggtitle("numero de proteinas por funcao dividido pelo numero de cogs na especie") +
  plot_config
ggsave("plots/fig5.pdf", width = 20, height = 10)
```


# wrangle
```{r}
count_by_taxid <- cog_size_by_taxid %>%
  inner_join(cog_annotation) %>%
  count(taxid, annotation, wt = cog_size) %>%
  left_join(ordered_species)

ggplot(count_by_taxid) +
  geom_bar(aes(x = ncbi_name, y = n), stat = "identity") +
  facet_grid(annotation ~ ., scales = "free_y")
```


```{r message=FALSE}
cog_annotation_collapse <- cog_annotation %>%
  group_by(cog_id) %>%
  summarise(annotation = paste(annotation, collapse = " "))

protein_count_by_cog <- orthodist %>%
  group_by(taxid, cog_id) %>%
  summarise(count = sum(count)) %>%
  ungroup(taxid, annotation) %>%
  inner_join(cog_annotation_collapse) %>%
  inner_join(spbranches) %>%
  inner_join(string_eukaryotes %>% select(taxid, ncbi_name)) %>%
  mutate(
    ncbi_name = factor(ncbi_name, levels = ncbi_name[order(-root)]   %>% unique),
    cog_id    = factor(cog_id,    levels = cog_id[order(annotation)] %>% unique)
  )

t <- ggplot(protein_count_by_cog) +
  geom_bar(aes(x = ncbi_name, y = count, fill = annotation), stat="identity") +
  facet_grid(cog_id ~ ., scales = "free_y") +
  ggtitle("numero de proteinas por cog, para cada especie") +
  plot_config[-1] +
  theme(strip.text.y = element_text(size = 6)) #+
  # theme(legend.text = element_text(margin = margin(t = 1.5, b = 1.5, unit = "in")))
ggsave("plots/abundance_protein_count_by_cog.pdf", t, width = 20, height = 50, limitsize = FALSE)
```
