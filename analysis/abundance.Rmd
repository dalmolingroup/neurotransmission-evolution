---
title: "Network"
output:
  html_document:
    df_print: paged
    theme: default
    highlight: espresso
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
---
# Intro
Obter o layout da rede no RedeR
```{r message=FALSE}
library(tidyverse)
library(magrittr)
```

# Dados
```{r rows.print=5}
data(
  ogr,
  ogp,
  gene_ids,
  gene_pathways,
  neurotransmission_cogs,
  string_eukaryotes,
  package = "neurotransmission"
)

gene_annotation <- read_tsv("../inst/extdata/gene_annotation.tsv", col_types = "cc") %>%
  mutate(annotation = case_when(
    grepl("clearance",annotation) ~ "depletion",
    grepl("degradation",annotation) ~ "depletion",
    grepl("transport",annotation) ~ "synthesis",
    TRUE ~ annotation
  ))

cog_roots <- read_tsv("../inst/extdata/cogs_roots.tsv", col_types = "ci")

spbranches <- ogr@spbranches %>% select(taxid = ssp_id, root = `9606`)
```

# joining data
```{r}
neurotransmission_cogs %<>%
  inner_join(cog_roots) %>%
  group_by(string_id) %>%
  filter(root == max(root))

info <- gene_ids %>%
  na.omit %>%
  inner_join(gene_pathways) %>%
  inner_join(gene_annotation) %>%
  inner_join(neurotransmission_cogs)
```

# wrangle
```{r}
cog_annotation <- info %>% select(cog_id, annotation) %>% unique

orthodist <- ogp@orthodist %>%
  as.data.frame %>%
  rownames_to_column("taxid") %>%
  pivot_longer(cols = -taxid, names_to = "cog_id", values_to = "count")

orthodist_annotation <- inner_join(orthodist, cog_annotation)
```

# plot
```{r message=FALSE}
ssp_abundance <- orthodist %>%
  group_by(taxid) %>%
  summarise(abundance = { sum(count)/sum(count > 0) }) %>%
  inner_join(spbranches) %>%
  arrange(-root) %>%
  mutate(taxid = factor(taxid, levels = taxid[order(-root)]))
  
ggplot(ssp_abundance) +
  geom_bar(aes(x = taxid, y = abundance), stat="identity")
```


```{r}
annotation_abundance <- orthodist_annotation %>%
  filter(count > 0) %>%
  group_by(taxid, annotation) %>%
  summarise(abundance = { sum(count)/sum(count > 0) }) %>%
  ungroup(taxid, annotation) %>%
  inner_join(spbranches) %>%
  inner_join(string_eukaryotes %>% select(taxid, ncbi_name)) %>%
  mutate(ncbi_name = factor(ncbi_name, levels = ncbi_name[order(-root)] %>% unique))

porifera_xintercept <- which(levels(annotation_abundance$ncbi_name) == "Amphimedon queenslandica")

plot_config <- list(
  facet_grid(annotation ~ ., scales = "free_y"),
  geom_vline(xintercept = porifera_xintercept, color = "#FF0000", linetype = "11", size = 0.25),
  theme(axis.text.x = element_text(size = 3, angle = 90, hjust = 1, vjust = 0))
)

ggplot(annotation_abundance) +
  geom_bar(aes(x = ncbi_name, y = abundance), stat="identity") +
  ggtitle("numero de proteinas por funcao dividido pelo numero de cogs da funcao") +
  plot_config
ggsave("plots/abundance_by_function.pdf", width = 20, height = 10)
```


```{r}
annotation_count <- orthodist_annotation %>%
  group_by(taxid, annotation) %>%
  summarise(count = sum(count)) %>%
  ungroup(taxid, annotation) %>%
  inner_join(spbranches) %>%
  inner_join(string_eukaryotes %>% select(taxid, ncbi_name)) %>%
  mutate(ncbi_name = factor(ncbi_name, levels = ncbi_name[order(-root)] %>% unique))

porifera_xintercept <- which(levels(annotation_abundance$ncbi_name) == "Amphimedon queenslandica")

ggplot(annotation_count) +
  geom_bar(aes(x = ncbi_name, y = count), stat="identity") +
  ggtitle("numero de proteinas por funcao") +
  plot_config
ggsave("plots/abundance_count.pdf", width = 20, height = 10)
```


```{r}
cog_count_by_taxid <- orthodist %>%
  group_by(taxid) %>%
  summarise(count_cog = sum(count > 0))

annotation_count_by_all_cogs <- orthodist_annotation %>%
  group_by(taxid, annotation) %>%
  summarise(count_annotation = sum(count)) %>%
  ungroup(taxid, annotation) %>%
  inner_join(cog_count_by_taxid) %>%
  inner_join(spbranches) %>%
  inner_join(string_eukaryotes %>% select(taxid, ncbi_name)) %>%
  mutate(abundance = count_annotation / count_cog) %>%
  mutate(ncbi_name = factor(ncbi_name, levels = ncbi_name[order(-root)] %>% unique))

ggplot(annotation_count_by_all_cogs) +
  geom_bar(aes(x = ncbi_name, y = abundance), stat="identity") +
  ggtitle("numero de proteinas por funcao dividido pelo numero de cogs na especie") +
  plot_config
ggsave("plots/abundance_by_all_cogs.pdf", width = 20, height = 10)
```

