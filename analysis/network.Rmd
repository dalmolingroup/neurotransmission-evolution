---
title: "Network"
knit: neurotransmissionevolution::custom_knit
---
```{r include=FALSE}
knitr::opts_chunk$set(
   warning     = FALSE
  ,message     = FALSE
  ,cache       = 1
  ,autodep     = T
  # ,cache.extra = file.mtime("download/link_pathway_entrez.tsv")
)
```

### Graph data
Loading resources:
```{r}
# Data manipulation
library(tidyverse)
library(igraph)
library(magrittr)

# Plotting dependencies
library(scatterpie)
library(UpSetR)
library(gridExtra)
library(patchwork)

# Utils
library(neurotransmissionevolution)

# Packaged data
data(
   gene_ids
  ,gene_cogs
  ,gene_pathways
  ,string_edgelist
  ,pathway_neuroexclusivity
  ,expression_neuroexclusivity
  ,package = "neurotransmissionevolution"
)

# Fresh analysis data
cog_roots                   <- read_tsv("geneplast_roots.tsv",             col_types = "ci")
clade_names                 <- read_tsv("geneplast_clade_names.tsv",       col_types = "ic")
pathway_neuroexclusivity    <- read_tsv("neuroexclusivity_pathway.tsv",    col_types = "cn")
expression_neuroexclusivity <- read_tsv("neuroexclusivity_expression.tsv", col_types = "cn")

# Collapsing similar functions
gene_annotation <- read_tsv("../data/gene_annotation.tsv", col_types = "cc") %>%
  mutate(annotation = case_when(
     grepl("clearance",   annotation) ~ "depletion"
    ,grepl("degradation", annotation) ~ "depletion"
    ,grepl("transport",   annotation) ~ "synthesis"
    ,TRUE ~ annotation
  ))
```

We start by joining all gene data and creating the graph object.
```{r}
# If a gene has more than 1 COG, select the oldest one.
# This is unusual, but can happen in cases of gene fusion, for instance.
gene_cogs %<>%
  inner_join(cog_roots) %>%
  group_by(string_id) %>%
  filter(root == max(root)) %>%
  inner_join(clade_names)

# Gathering all gene info available
vertices <- gene_ids %>%
  na.omit %>%
  inner_join(gene_cogs) %>%
  inner_join(gene_pathways) %>%
  inner_join(gene_annotation) %>%
  inner_join(pathway_neuroexclusivity) %>%
  inner_join(expression_neuroexclusivity) %>%
  mutate(ne = pathway_neuroexclusivity >= 0.9) %>%
  select(string_id, everything())

# Quick color hack to aid visualization
vertices %<>%
  unite(color, glutamatergic:dopaminergic, remove = F) %>%
  mutate(color = rainbow(color %>% n_distinct)[color %>% as.factor])

g <- graph_from_data_frame(string_edgelist, directed = F, vertices = vertices)

# Setting node sizes
V(g)$size <- V(g)$system_count %>% sqrt %>% multiply_by(5)
```

The following block calls an utility function that handles the force directed layout with the aid of a shiny web server and the VivaGraphJS javascript library. A computed layout is already available in this folder.
```{r}
if(file.exists("network_layout.tsv")) {
  layout <- read_tsv("network_layout.tsv", col_types = "dd") %>% as.matrix
} else {
  layout <- vivagraph(g, precompute_multiplier = 200, precompute_niter = 1000)
}

# inserting layout coordinates into graph object
V(g)$x <-  layout[, 1]
# layout matrix comes vertically flipped
V(g)$y <- -layout[, 2]
```

```{r eval=FALSE, include=FALSE}
# layout %<>% rotate_layout(0)
# 
# layout <- vivagraph(g, layout, repin = T, pinned_cols = 2)
# 
# write_tsv(layout %>% as.data.frame, "layout.tsv")
```

We use base ggplot2 to draw the network. Edges are represented by a common `geom_path` layer. The following block retrieves tidy edge coordinates for the `geom_path` calls.
```{r}
# Recreating the vertices data.frame, now with layout coordinates (lazy way)
vertices <- igraph::as_data_frame(g, what = "vertices") %>% rename(string_id = name)

# The edges data.frame will be used to draw lines with geom_path
edges <- string_edgelist %>%
    map(match, vertices[["string_id"]]) %>%
    map_dfr(~ vertices[.x,]) %>%
    select(x:y) %>%
    cbind(group = 1:nrow(string_edgelist))
```

Setting up reusable aesthetic parameters to avoid code duplication.
```{r}
pie_colors <- c(
   "cholinergic"   = "#D84315"
  ,"dopaminergic"  = "#F9A825"
  ,"gabaergic"     = "#558B2F"
  ,"glutamatergic" = "#1565C0"
  ,"serotonergic"  = "#6A1B9A"
)
plot_pie_fill <- scale_fill_manual(values = pie_colors)

element_colors <- c(
   "depletion"             = "#F40000"
  ,"excitability"          = "#FFAB00"
  ,"receptor-associated"   = "#D6EE00"
  ,"ionotropic receptor"   = "#43FF1C"
  ,"metabotropic receptor" = "#18FFFF"
  ,"signaling"             = "#0091EA"
  ,"g-protein"             = "#0033ff"
  ,"synthesis"             = "#AA00FF"
  ,"vesicle"               = "#FF00AA"
  #------- is_neuroexclusive --------
  ,"TRUE"                  = "#00BFC4"
  ,"FALSE"                 = "#F8766D"
)
# Color and size scales for neurotransmission functions
plot_scales <- list(
   scale_fill_manual(values = element_colors)
  ,scale_color_manual(values = element_colors %>% darken(0.25))
  ,scale_radius(range = c(1.75, 5.00), guide = FALSE)
)

systems <- names(pie_colors)

edge_color <- rgb(0.7, 0.7, 0.7, alpha = 0.3)

past_fill  <- "#FFFFFF" # past nodes' fill color
past_color <- "#888888" # past nodes' border color

# Baking some aesthetic properties into the vertices data.frame
vertices %<>% mutate(
  shape      = ifelse(ne, "square filled", "circle filled"),
  color_node = ifelse(ne, "#000000", element_colors[annotation] %>% darken(0.2)),
  color_pie  = ifelse(ne, "#000000", NA),
)

# Some recurrent ggplot aesthetics
edge_aes <- aes(x = x, y = y, group = group)
text_aes <- aes(x = x, y = y, label = string_name)
pie_aes  <- aes(x = x, y = y, group = string_id, r = size^(0.94) - 1.5)

# Fixing xy limits across all plots
xy_lim <- list(
  scale_x_continuous(limits = range(vertices[["x"]]) + c(-50, 50)),
  scale_y_continuous(limits = range(vertices[["y"]]) + c(-50, 50))
)

# Emptying theme defaults
plot_theme <- list(coord_equal(), theme_void())

# Allowing more space for multiple network plots
diff_theme <- list(
  coord_equal(),
  theme_void(),
  theme(
     plot.title         = element_text(size = 8, hjust = 0.5)
    ,legend.text        = element_text(size = 6)
    ,legend.title       = element_text(size = 8)
    ,legend.key.size    = unit( 1, "mm")
    ,legend.box.spacing = unit(-2, "mm")
    ,legend.box.margin  = unit(c(0, 2, 0, 0), "mm")
    ,plot.margin        = unit(c(0, 0, 0, 0), "mm")
  )
)

# Numeric vector named with clade names
roots <- vertices %>%
  arrange(-root) %>%
  distinct(root, clade_name) %$%
  set_names(root, clade_name)

upset_texts <- c(
   3   #ytitle
  ,2   #ytick
  ,1   #setsizetitle
  ,1.5 #setsizetick
  ,2   #setnames
  ,2.5 #barnums
)
```

### Manuscript figure 1
```{r fig.align="center", fig.height=6, fig.width=14, fig.cap="Unedited manuscript figure 1. The human neurotransmission network with nodes colored by neurotransmitter systems (left) and neurotransmission functions (right)."}
####################
## Common elements
####################
plot_edges <- geom_path(
   data    = edges
  ,mapping = edge_aes
  ,color   = edge_color
  ,size    = 0.1
)

plot_text <- geom_text(
   data    = vertices
  ,mapping = text_aes
  ,size    = 1
  ,vjust   = 0
  ,nudge_y = 6
  ,alpha   = 0.5
)

##############
## Figure 1A
##############
plot_pies <- geom_scatterpie(
   data    = vertices
  ,mapping = pie_aes
  ,cols    = systems
  ,color   = NA
)

fig1a <- ggplot() +
  plot_theme +
  plot_edges +
  plot_pies +
  plot_pie_fill +
  plot_text

##############
## Figure 1B
##############
plot_nodes <- geom_point(
   data    = vertices
  ,mapping = aes(x, y, fill = annotation, color = annotation, size = size)
  ,shape   = 21
  ,stroke  = 0.5
)
  
fig1b <- ggplot() +
  plot_theme +
  plot_edges +
  plot_nodes +
  plot_scales +
  plot_text

# Plotting and saving
fig1a + fig1b
ggsave("plots/fig1_raw.pdf", width = 14, height = 7, onefile = F, useDingbats = F)
```

### Manuscript figure 2
This figure is produced externally by a program called ViaComplex. ViaComplex superimposes a heatmap over the network layout based on a node property. This property, in our case, is a node's neuroexclusivity. The following block handles data formatting related to ViaComplex.
```{r}
# Retrieving the largest connected component
subgraphs <- decompose.graph(g)
lcc_index <- which.max(sapply(subgraphs, vcount))
lcc       <- subgraphs[[lcc_index]]

# Writing network data to viacomplex's custom format (similar to pajek)
# xy_hack adds some extra margin to the plot
xy_hack <- data.frame(
   name                        = c("top", "bot")
  ,x                           = range(V(lcc)$x) + c(-75, 75)
  ,y                           = range(V(lcc)$y) + c(-75, 75)
  ,pathway_neuroexclusivity    = 0
  ,expression_neuroexclusivity = 0
  ,stringsAsFactors            = F
)

pajek_nodes <- lcc %>%
  igraph::as_data_frame("vertices") %>%
  bind_rows(xy_hack) %>%
  mutate(id = row_number(), y = -y)

pajek_edges <- igraph::as_data_frame(lcc, "edges")

# Creating the network_viacomplex.net file and sequentially populating it
write("*edges", "network_viacomplex.net")
write_tsv(
   x            = pajek_edges
  ,path         = "network_viacomplex.net"
  ,append       = T
  ,col_names    = F
  ,quote_escape = F
)
write("*nodes", "network_viacomplex.net", append = T)
write_tsv(
   x            = pajek_nodes %>% select(name, x, y)
  ,path         = "network_viacomplex.net"
  ,append       = T
  ,col_names    = F
  ,quote_escape = F
)

write_tsv(
   x    = pajek_nodes %>% select(id, name, pathway_neuroexclusivity)
  ,path = "network_viacomplex_pathway.dat"
)
write_tsv(
   x    = pajek_nodes %>% select(id, name, expression_neuroexclusivity)
  ,path = "network_viacomplex_expression.dat"
)
```

### Manuscript figure 3  
The process for generating Figures 3 and 4 is roughly the same. It consists of finding what nodes have numeric roots in a given range. In our analysis, the largest root is numbered 37 and represents the oldest common ancestor to humans in the cladogram (the Human-Metamonada LCA, as seen in previous sections). Root number 1 is represented by _Homo sapiens_ itself.  
The nodes we need to draw are either `current_nodes` (roots in a specified numeric range), or `past_nodes` (roots > such specified range). The edges we need to draw are all edges between both sets of nodes.  
**Manuscript Figure 3A**
```{r}
# Finding which genes should be drawn
current_genes <- vertices %>% filter(root == 37)

# Finding which edges should be drawn
partial_ids   <- current_genes %>% pull(string_id)
which_edges   <- apply(string_edgelist, 1, function(r) all(r %in% partial_ids))
partial_edges <- edges[which_edges,]

plot_edges <- geom_path(
   data    = partial_edges
  ,mapping = edge_aes
  ,color   = edge_color
  ,size    = 0.1
)

plot_text <- geom_text(
   data    = current_genes
  ,mapping = text_aes
  ,size    = 1
  ,vjust   = 0
  ,nudge_y = 1.75
  ,alpha   = 0.5
)

plot_current_pies <- geom_scatterpie(
   data    = current_genes
  ,mapping = pie_aes
  ,cols    = systems
  ,color   = NA
)

# Assembling
fig3a <- ggplot() +
  plot_edges +
  plot_scales +
  xy_lim +
  plot_current_pies +
  plot_pie_fill +
  plot_text +
  plot_theme
```

**Manuscript Figure 3B**  
For Figure 3B, we want to see what nodes have numeric roots < 37 (Human-Metamonada LCA) and >= 26 (Human-Cnidaria LCA).
```{r fig.align="center", fig.height=5.5, fig.width=14, fig.cap="Unedited manuscript figure 3. The human neurotransmission network with nodes colored by neurotransmitter systems and neurotransmission functions."}
# Finding which genes should be drawn
current_genes <- vertices %>% filter(root < 37 & root >= 26)
past_genes    <- vertices %>% filter(root == 37)

# Finding which edges should be drawn
partial_ids   <- c(current_genes[["string_id"]], past_genes[["string_id"]])
which_edges   <- apply(string_edgelist, 1, function(r) all(r %in% partial_ids))
partial_edges <- edges[which_edges,]

plot_edges <- geom_path(
   data    = partial_edges
  ,mapping = edge_aes
  ,color   = edge_color
  ,size    = 0.1
)

plot_past <- geom_point(
   data    = past_genes
  ,mapping = aes(x, y, size = size)
  ,fill    = past_fill
  ,color   = past_color
  ,shape   = past_genes$shape
  ,stroke  = 0.25
)

plot_text <- geom_text(
   data    = current_genes
  ,mapping = text_aes
  ,size    = 1
  ,vjust   = 0
  ,nudge_y = 1.75
  ,alpha   = 0.5
)

plot_current_pies <- geom_scatterpie(
   data    = current_genes
  ,mapping = pie_aes
  ,cols    = systems
  ,color   = NA
)

# Assembling
fig3b <- ggplot() +
  plot_edges +
  plot_past +
  plot_scales +
  xy_lim +
  plot_current_pies +
  plot_pie_fill +
  plot_text +
  plot_theme

# Plotting and saving
fig3a + fig3b
ggsave("plots/fig3_raw.pdf", width = 14, height = 7, onefile = F, useDingbats = F)
```

Additionally, we cumulatively count nodes by their categories (function and neuroexclusivity) and inferred root:
```{r}
cumulative_emergence <- vertices %>%
  select(root, annotation, is_neuroexclusive = ne) %>%
  # Adding clade info
  right_join(clade_names) %>%
  # Pivoting from wide to long
  pivot_longer(annotation:is_neuroexclusive, values_ptypes = list(value = "character")) %>%
  # Counting nodes by category (name) for each root
  count(root, clade_name, name, value) %>%
  # Making absent counts explicit
  group_by(name) %>%
  complete(nesting(root, clade_name), name, value, fill = list(n = 0)) %>%
  # No reason to include NA observations in cumulative sum
  na.omit %>%
  # Cumulative sum node count at each root
  group_by(name, value) %>%
  mutate(cumulative_count = order_by(-root, cumsum(n)))
```

Plotting such cumulative counts:
```{r fig.align="center", fig.height=8, fig.width=16, fig.cap="Cumulative node counts by categories at each root."}
cumulative_emergence %<>% ungroup %>%
  # Creating ordered factors for plotting
  mutate(
     clade_name = fct_reorder(clade_name, -root)
    ,value      = fct_reorder(value, name)
  )

ggplot(cumulative_emergence) +
  #----- Barplot ------
  geom_bar(
     mapping     = aes(clade_name, cumulative_count, group = value)
    ,stat        = "sum"
    ,fill        = "#999999"
    ,show.legend = F
  ) +
  #----- Lines ------
  geom_line(
     mapping = aes(clade_name, cumulative_count, group = value, color = value)
    ,size    = 1
  ) +
  #----- Styling ------
  scale_color_manual(values = element_colors) +
  facet_grid(name ~ .) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

### Manuscript figure 4  
Visualizing nodes with roots <= 30 (Human-Porifera LCA) and >= 26 (Human-Cnidaria LCA) at every distinct root.
```{r fig.align="center", fig.height=2, fig.width=10, fig.cap="Unedited manuscript figure 4. The human neurotransmission network with nodes rooted between roots 30 (Human-Choanoflagellata LCA) and 26 (Human-Cnidaria LCA)."}
plot_size <- scale_radius(range = c(0.5, 1.5), guide = FALSE)

fig4 <- roots[roots >= 26 & roots <= 30] %>%
  imap(~ {
  # Finding which genes should be drawn
  current_genes <- vertices %>% filter(root == .x)
  past_genes    <- vertices %>% filter(root  > .x)
  
  # Finding which edges should be drawn
  partial_ids   <- c(current_genes[["string_id"]], past_genes[["string_id"]])
  which_edges   <- apply(string_edgelist, 1, function(r) all(r %in% partial_ids))
  partial_edges <- edges[which_edges,]
  
  plot_edges <- geom_path(
     data    = partial_edges
    ,mapping = edge_aes
    ,color   = edge_color
    ,size    = 0.1
  )
  
  plot_past <- geom_point(
     data    = past_genes
    ,mapping = aes(x, y, size = size)
    ,fill    = past_fill
    ,color   = past_color
    ,shape   = past_genes$shape
    ,stroke  = 0.25
  )
  
  plot_text <- geom_text(
     data    = current_genes
    ,mapping = text_aes
    ,size    = 0.8
    ,vjust   = -0.5
    ,nudge_y = 1
    ,alpha   = 0.5
  )
  
  plot_current_nodes <- geom_point(
     data    = current_genes
    ,mapping = aes(x, y, fill = annotation, size = size)
    ,color   = current_genes$color_node
    ,shape   = current_genes$shape
    ,stroke  = 0.25
  )
  
  remove_legend <- guides(fill = "none", colour = "none")
  
  # Assembling
  ggplot() +
    ggtitle(paste(.y, "LCA")) +
    diff_theme +
    xy_lim +
    plot_edges +
    plot_past +
    plot_current_nodes +
    plot_scales +
    plot_size +
    plot_text +
    remove_legend
})

fig4 <- invoke(grid.arrange, fig4, ncol = 5)

ggsave(
  "plots/fig4_raw.pdf"
  ,plot        = fig4
  ,width       = 9*0.9
  ,height      = 5*0.9
  ,onefile     = F
  ,useDingbats = F
)
```

### Supplementary network figures  
The following supplementary figures help us see what nodes have been rooted at each LCA. Nodes rooted at previous LCAs are colored white.
```{r fig.align="center", fig.height=10, fig.width=8, fig.cap="The human neurotransmission network with nodes rooted at each human LCA."}
system_plots   <- list()
function_plots <- list()

iwalk(roots, ~ {
  # Finding which genes should be drawn
  current_genes <- vertices %>% filter(root == .x)
  past_genes    <- vertices %>% filter(root  > .x)
  
  # Finding which edges should be drawn
  partial_ids   <- c(current_genes[["string_id"]], past_genes[["string_id"]])
  which_edges   <- apply(string_edgelist, 1, function(r) all(r %in% partial_ids))
  partial_edges <- edges[which_edges,]
  
  # Common elements -----------
  plot_edges <- geom_path(
     data    = partial_edges
    ,mapping = edge_aes
    ,color   = edge_color
    ,size    = 0.1
  )
  
  plot_past <- geom_point(
     data    = past_genes
    ,mapping = aes(x, y, size = size)
    ,fill    = past_fill
    ,color   = past_color
    ,shape   = past_genes$shape
    ,stroke  = 0.25
  )
  
  plot_text <- geom_text(data = current_genes, text_aes, size = 1, nudge_y = 2, alpha = 0.5)
  
  base <- ggplot() +
    ggtitle(paste0("Human-", .y, " LCA (#", .x, ")")) +
    diff_theme +
    xy_lim +
    plot_edges +
    plot_past +
    plot_size
  
  # Nodes colored by system -----------
  plot_current_pies <- geom_scatterpie(data = current_genes, pie_aes, cols = systems, color = NA)
  
  system_plots[[as.character(.x)]] <<- base +
    plot_current_pies +
    plot_pie_fill +
    plot_text
  
  # Nodes colored by function --------
  plot_current_nodes <- geom_point(
     data    = current_genes
    ,mapping = aes(x, y, fill = annotation, size = size)
    ,color   = current_genes$color_node
    ,shape   = current_genes$shape
    ,stroke  = 0.25
  )
  
  function_plots[[as.character(.x)]] <<- base +
    plot_current_nodes +
    plot_scales +
    plot_size +
    plot_text +
    guides(fill = guide_legend(override.aes = list(shape = 21))) # legend hack
})

# Printing and saving
arrangeGrob(grobs = system_plots, ncol = 3) %>% grid::grid.draw()
```
```{r fig.align="center", fig.height=9.5, fig.width=8, fig.cap="The human neurotransmission network with nodes rooted at each human LCA."}
arrangeGrob(grobs = function_plots, ncol = 3) %>% grid::grid.draw()
```

### Manuscript set diagrams  
Given the dificulties of joining ggplot and base plots, the set diagrams have to be plotted by themselves:
```{r results='hide', fig.cap='Set diagrams', fig.subcap=c('Set diagram for Figure 1A', 'Set diagram for Figure 3A', 'Set diagram for Figure 3B'), fig.width=20, fig.height=5, fig.ncol = 1}
# We have to manually find the correct order of colors
# Because UpSetR does not understand named vectors
get_colors <- function(df) {
  ordered_systems <- df %>%
    select(systems) %>%
    colSums %>%
    extract(. > 0) %>%
    extract(order(., names(.), decreasing = T))

  pie_colors[names(ordered_systems)]
}

# Figure 1A set diagram
upset(
   select(vertices, systems)
  ,mb.ratio        = c(0.7, 0.3)
  ,order.by        = "freq"
  ,mainbar.y.label = "System Intersections"
  ,sets.x.label    = "Genes per system"
  ,text.scale      = upset_texts
  ,point.size      = 3.5
  ,line.size       = 1
  ,sets.bar.color  = get_colors(vertices)
)
dev.print(pdf, "plots/fig1a_set_raw.pdf", width = 18, height = 10, onefile = F, useDingbats = F)

# Figure 3A set diagram
fig3a_set <- vertices %>% filter(root == 37) %>% select(systems)
upset(
   fig3a_set
  ,mb.ratio        = c(0.7, 0.3)
  ,order.by        = "freq"
  ,mainbar.y.label = "System Intersections"
  ,sets.x.label    = "Genes per system"
  ,text.scale      = upset_texts
  ,point.size      = 3.5
  ,line.size       = 1
  ,sets.bar.color  = get_colors(fig3a_set)
)
dev.print(pdf, "plots/fig3a_set_raw.pdf", width = 16, height = 8, onefile = F, useDingbats = F)

# Figure 3B set diagram
fig3b_set <- vertices %>% filter(root < 37 & root >= 26) %>% select(systems)
upset(
   fig3b_set
  ,mb.ratio        = c(0.7, 0.3)
  ,order.by        = "freq"
  ,mainbar.y.label = "System Intersections"
  ,sets.x.label    = "Genes per system"
  ,text.scale      = upset_texts
  ,point.size      = 3.5
  ,line.size       = 1
  ,sets.bar.color  = get_colors(fig3b_set)
)
dev.print(pdf, "plots/fig3b_set_raw.pdf", width = 16, height = 8, onefile = F, useDingbats = F)
```
