---
title: "Network"
output:
  html_document:
    df_print: paged
    theme: default
    highlight: espresso
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
---
# Intro
Obter o layout da rede no RedeR
```{r message=FALSE}
library(tidyverse)
library(igraph)
library(magrittr)
library(gridExtra)

library(Hmisc)
library(scatterpie)
library(UpSetR)

library(neurotransmission)
```

# Dados
```{r rows.print=5}
data(
  gene_ids,
  gene_pathways,
  string_edgelist,
  neurotransmission_cogs,
  pathway_neuroexclusivity,
  # layout,
  package = "neurotransmission"
)

gene_annotation <- read_tsv("../inst/extdata/gene_annotation.tsv", col_types = "cc") %>%
  mutate(annotation = case_when(
    grepl("clearance",   annotation) ~ "depletion",
    grepl("degradation", annotation) ~ "depletion",
    grepl("transport",   annotation) ~ "synthesis",
    TRUE ~ annotation
  ))

cog_roots <- read_tsv("../inst/extdata/cogs_roots.tsv", col_types = "ci")

roots_extant_clades <- read_tsv("extant_clades.tsv", col_types = "ic")
```

# RedeR
```{r}
neurotransmission_cogs %<>%
  inner_join(cog_roots) %>%
  group_by(string_id) %>%
  filter(root == max(root)) %>%
  inner_join(roots_extant_clades)

vertices <- gene_ids %>%
  na.omit %>%
  inner_join(gene_pathways) %>%
  inner_join(gene_annotation) %>%
  inner_join(neurotransmission_cogs) %>%
  inner_join(pathway_neuroexclusivity) %>%
  mutate(ne = pathway_neuroexclusivity >= 0.9) %>%
  select(string_id, everything())

# color hack
vertices %<>%
  unite(color, vesicle:dopaminergic, remove = F) %>%
  mutate(color = rainbow(color %>% unique %>% length)[color %>% as.factor])

g <- graph_from_data_frame(string_edgelist, directed = F, vertices = vertices)

# removing vesicle cycle-only nodes
g %<>% delete_vertices(which(V(g)$system_count == 0))

V(g)$size <- V(g)$system_count %>% sqrt %>% multiply_by(5)
```

# Layout
```{r}
if(file.exists("layout.tsv")) {
  layout <- read_tsv("layout.tsv", col_types = "dd") %>% as.matrix
} else {
  layout <- vivagraph(g, precompute_multiplier = 200, precompute_niter = 1000)
}
```

# Position adjustments, rerun as needed
```{r}
# layout %<>% rotate_layout(0)
# 
# layout <- vivagraph(g, layout, repin = T, pinned_cols = 2)
# 
# write_tsv(layout %>% as.data.frame, "layout.tsv")
```

# Making edges data.frame
```{r}
V(g)$x <-  layout[, 1]
V(g)$y <- -layout[, 2]

vertices <- igraph::as_data_frame(g, what = "vertices") %>% rename(string_id = name)
edgelist <- igraph::as_data_frame(g, what = "edges")

from <- vertices[match(edgelist[[1]], vertices[["string_id"]]), c("x","y")]
to <- vertices[match(edgelist[[2]], vertices[["string_id"]]), c("x","y")]

edges <- rbind(from, to) %>% cbind(group = 1:nrow(edgelist))
```

# Config
```{r}
pie_colors <- c(
  "cholinergic"   = "#D84315",
  "dopaminergic"  = "#F9A825",
  "gabaergic"     = "#558B2F",
  "glutamatergic" = "#1565C0",
  "serotonergic"  = "#6A1B9A"
)

element_colors <- c(
  "depletion"             = "#F40000",
  "excitability"          = "#FFAB00",
  "receptor-associated"   = "#D6EE00",
  "ionotropic receptor"   = "#43FF1C",
  "metabotropic receptor" = "#18FFFF",
  "signaling"             = "#0091EA",
  "g-protein"             = "#0033ff",
  "synthesis"             = "#AA00FF",
  "vesicle"               = "#FF00AA"
)

sistemas <- names(pie_colors)

edge_color <- rgb(0.7,0.7,0.7,alpha = 0.3)

past_fill  <- "#FFFFFF"
past_color <- "#888888"

vertices %<>% mutate(
  shape = ifelse(ne, 22, 21),
  color_node = ifelse(ne, "#000000", element_colors[annotation] %>% darken(0.2)),
  color_pie = ifelse(ne, "#000000", NA),
)

# reusable aesthetics
edge_aes <- aes(x = x, y = y, group = group)
pie_aes  <- aes(x = x, y = y, group=string_id, r = size^(0.94) - 1.5)
text_aes <- aes(x = x, y = y, label = string_name)

#xy boundaries
xy_lim <- list(
  scale_x_continuous(limits = range(vertices[["x"]]) + c(-50, 50)),
  scale_y_continuous(limits = range(vertices[["y"]]) + c(-50, 50))
)

diff_theme <- list(
  coord_equal(),
  theme_void(),
  theme(
    plot.title         = element_text(size=8, hjust = 0.5),
    legend.text        = element_text(size=6),
    legend.title       = element_text(size=8),
    plot.margin        = unit(c(0, 0, 0, 0),"mm"),
    legend.key.size    = unit(1,"mm"),
    legend.box.spacing = unit(-2,"mm"),
    legend.box.margin  = unit(c(0, 2, 0, 0),"mm")
  )
)

roots <- vertices %>% arrange(-root) %>% pull(root) %>% unique
roots_titles <- vertices %>% arrange(-root) %>% pull(extant_name) %>% unique %>% paste0(" LCA (",roots,")")

upset_texts <- c(
  3 #ytitle
  ,2 #ytick
  ,1 #setsizetitle
  ,1.5 #setsizetick
  ,2 #setnames
  ,2.5 #barnums
)
```

# systems
```{r message=FALSE}
# edge lines
plot_edges <- geom_path(data = edges, edge_aes, color = edge_color, size = 0.1)

#piecharts
plot_pies <- geom_scatterpie(data = vertices, pie_aes, cols = sistemas, color = NA)

# plor scale
plot_pie_fill <- scale_fill_manual(values = pie_colors)

#labels
plot_text <- geom_text(data = vertices, text_aes, size = 1, vjust = 0, nudge_y = 6, alpha=0.5)

# misc
plot_theme <- list(coord_equal(), theme_void())

complete_systems <- ggplot() + plot_theme + plot_edges + plot_pies + plot_pie_fill + plot_text

complete_systems
  
ggsave("plots/fig1a.pdf", width = 7, height = 7,onefile=F,useDingbats=FALSE)
```

# functions
```{r message=FALSE}
# nodes
plot_nodes <- geom_point(
  data = vertices,
  aes(x=x, y=y, fill=annotation, color=annotation, size=size),
  shape = 21,
  # shape = ifelse(vertices$ne,23,21),
  # color= ifelse(vertices$ne,"#000000",element_colors[vertices$annotation] %>% darken(0.25)), 
  stroke = 0.5
)

# color and size scales
plot_scales <- list(
  scale_fill_manual(values = element_colors),
  scale_color_manual(values = element_colors %>% darken(0.25) %>% setNames(names(element_colors))),
  scale_radius(range = c(1.75, 5.00), guide = FALSE)
)
  
complete_functions <- ggplot() + plot_theme + plot_edges + plot_nodes + plot_scales + plot_text

complete_functions
  
ggsave("plots/fig1b.pdf", width = 7, height = 7,onefile=F,useDingbats=FALSE)
```

### Rede Diferencial
```{r message=FALSE}
plot_size <- scale_radius(range = c(0.5, 1.3), guide = FALSE)

systems <- list()
functions <- list()

walk2(roots, roots_titles, ~ {
  
  #finding which genes should be drawn
  current_genes <- vertices %>% filter(root == .x)
  past_genes <- vertices %>% filter(root > .x)
  
  #finding which edges should be drawn
  partial_ids <- c(current_genes[["string_id"]], past_genes[["string_id"]])
  which_edges <- apply(edgelist, 1, function(r) all(r %in% partial_ids))
  partial_edges <- edges[which_edges,]
  
  ############
  ## COMMON
  ############
  plot_edges <- geom_path(data = partial_edges, edge_aes, color = edge_color, size = 0.1)
  
  plot_past <- geom_point(data = past_genes, aes(x, y, size = size), fill = past_fill, color = past_color, shape = past_genes$shape, stroke = 0.25)
  
  #labels
  plot_text <- geom_text(data = current_genes, text_aes, size = 1, vjust = 0, nudge_y = 1.75, alpha=0.5)
  
  ############
  ## SYSTEMS
  ############
  plot_current_pies <- geom_scatterpie(data = current_genes, pie_aes, cols = sistemas, color=NA)
  
  ##############
  ## FUNCTIONS
  ##############
  plot_current_nodes <- geom_point(data = current_genes, aes(x=x, y=y, fill = annotation, size = size), color = current_genes$color_node, shape = current_genes$shape, stroke = 0.25)
  
  ############
  ## SAVING
  ############
  base <- ggplot() + ggtitle(.y) + diff_theme + xy_lim + plot_edges + plot_past + plot_size
  
  systems[[as.character(.x)]] <<- base + plot_current_pies + plot_pie_fill + plot_text
  
  legend_hack <- guides(fill = guide_legend(override.aes=list(shape=21)))
  
  functions[[as.character(.x)]] <<- base + plot_current_nodes + plot_scales + plot_size + plot_text + legend_hack
})

#saving pdfs
ggsave(file = "plots/sup_systems_emergence.pdf", arrangeGrob(grobs = systems %>% rev, ncol = 3), width = 210, height = 297, units = "mm",onefile=F,useDingbats=FALSE)

ggsave(file = "plots/sup_functions_emergence.pdf", arrangeGrob(grobs = functions %>% rev, ncol = 3), width = 210, height = 297, units = "mm",onefile=F,useDingbats=FALSE)
```


# 4
```{r message=FALSE}
idx <- which(roots >= 26 & roots <= 29)

fig4 <- map2(roots[idx], roots_titles[idx], ~ {
  
  #finding which genes should be drawn
  current_genes <- vertices %>% filter(root == .x)
  past_genes <- vertices %>% filter(root > .x)
  
  #finding which edges should be drawn
  partial_ids <- c(current_genes[["string_id"]], past_genes[["string_id"]])
  which_edges <- apply(edgelist, 1, function(r) all(r %in% partial_ids))
  partial_edges <- edges[which_edges,]
  
  ############
  ## COMMON
  ############
  plot_edges <- geom_path(data = partial_edges, edge_aes, color = edge_color, size = 0.1)
  
  plot_past <- geom_point(data = past_genes, aes(x, y, size = size), fill = past_fill, color = past_color, shape = past_genes$shape, stroke = 0.25)
  
  #labels
  plot_text <- geom_text(data = current_genes, text_aes, size = 1, vjust = 0, nudge_y = 1.75, alpha=0.5)
  
  ##############
  ## FUNCTIONS
  ##############
  plot_current_nodes <- geom_point(data = current_genes, aes(x=x, y=y, fill = annotation, size = size), color = current_genes$color_node, shape = current_genes$shape, stroke = 0.25)
  
  ############
  ## SAVING
  ############
  base <- ggplot() + ggtitle(.y) + diff_theme + xy_lim + plot_edges + plot_past + plot_size
  
  legend_hack <- guides(fill = "none", colour = "none")
  
  base + plot_current_nodes + plot_scales + plot_size + plot_text + legend_hack
})

ggsave(file = "plots/fig4.pdf", arrangeGrob(grobs = fig4, ncol = 4), onefile=F, useDingbats=FALSE)
```

Fig 3A
```{r message=FALSE}
#finding which genes should be drawn
current_genes <- vertices %>% filter(root == 37)

#finding which edges should be drawn
partial_ids <- current_genes[["string_id"]]
which_edges <- apply(edgelist, 1, function(r) all(r %in% partial_ids))
partial_edges <- edges[which_edges,]

############
## COMMON
############
plot_edges <- geom_path(data = partial_edges, edge_aes, color = edge_color, size = 0.1)

plot_text <- geom_text(data = current_genes, text_aes, size = 1, vjust = 0, nudge_y = 1.75, alpha=0.5)

############
## SYSTEMS
############
plot_current_pies <- geom_scatterpie(data = current_genes, pie_aes, cols = sistemas, color=NA)

############
## SAVING
############
base <- ggplot() + plot_edges + plot_scales + xy_lim

fig3a <- base + plot_current_pies + plot_pie_fill + plot_text + plot_theme

fig3a

#saving pdfs
ggsave(file = "plots/fig3a.pdf",onefile=F,useDingbats=FALSE)
```

Fig 3B
```{r message=FALSE}
#finding which genes should be drawn
current_genes <- vertices %>% filter(root < 37 & root >= 26)
past_genes <- vertices %>% filter(root == 37)

#finding which edges should be drawn
partial_ids <- c(current_genes[["string_id"]], past_genes[["string_id"]])
which_edges <- apply(edgelist, 1, function(r) all(r %in% partial_ids))
partial_edges <- edges[which_edges,]

############
## COMMON
############
plot_edges <- geom_path(data = partial_edges, edge_aes, color = edge_color, size = 0.1)

plot_past <- geom_point(data = past_genes, aes(x, y, size = size), fill = past_fill, color = past_color, shape = past_genes$shape, stroke = 0.25)

#labels
plot_text <- geom_text(data = current_genes, text_aes, size = 1, vjust = 0, nudge_y = 1.75, alpha=0.5)

############
## SYSTEMS
############
plot_current_pies <- geom_scatterpie(data = current_genes, pie_aes, cols = sistemas, color=NA)

############
## SAVING
############
base <- ggplot() + plot_edges + plot_past + plot_scales + xy_lim

fig3b <- base + plot_current_pies + plot_pie_fill + plot_text + plot_theme

fig3b

#saving pdfs
ggsave(file = "plots/fig3b.pdf",onefile=F,useDingbats=FALSE)
```

# upset
```{r message=FALSE}
systems_totals <- colSums(vertices %>% select(sistemas))
systems_totals <- systems_totals[systems_totals>0]
systems_totals <- systems_totals[names(systems_totals)[order(names(systems_totals), decreasing = T)]]
setcolors <- pie_colors[names(systems_totals)[order(systems_totals, decreasing = T)]]

#1a
pdf("plots/fig1a_set.pdf",width=18,height=10,onefile=F,useDingbats=FALSE)
upset(
  vertices %>% select(sistemas)
  ,mb.ratio = c(0.7, 0.3)
  ,order.by = "freq"
  ,mainbar.y.label = "System Intersections"
  ,sets.x.label = "Genes per system"
  ,text.scale = upset_texts
  ,point.size = 3.5
  ,line.size = 1
  ,sets.bar.color = setcolors
)
dev.off()

#a
systems_totals <- colSums(vertices %>% filter(root == 37) %>% select(sistemas))
systems_totals <- systems_totals[systems_totals>0]
setcolors <- pie_colors[names(systems_totals)[order(systems_totals, decreasing = T)]]

pdf("plots/fig3a_set.pdf",width=16,height=8,onefile=F,useDingbats=FALSE)
upset(
  vertices %>% filter(root == 37) %>% select(sistemas)
  ,mb.ratio = c(0.7, 0.3)
  ,order.by = "freq"
  ,mainbar.y.label = "System Intersections"
  ,sets.x.label = "Genes per system"
  ,text.scale = upset_texts
  ,point.size = 3.5
  ,line.size = 1
  ,sets.bar.color = setcolors
)
dev.off()

#b
systems_totals <- colSums(vertices %>% filter(root < 37 & root >= 26) %>% select(sistemas))
systems_totals <- systems_totals[systems_totals>0]
setcolors <- pie_colors[names(systems_totals)[order(systems_totals, decreasing = T)]]

pdf("plots/fig3b_set.pdf",width=16,height=8,onefile=F,useDingbats=FALSE)
upset(
  vertices %>% filter(root < 37 & root >= 26) %>% select(sistemas)
  ,mb.ratio = c(0.7, 0.3)
  ,order.by = "freq"
  ,mainbar.y.label = "System Intersections"
  ,sets.x.label = "Genes per system"
  ,text.scale = upset_texts
  ,point.size = 3.5
  ,line.size = 1
  ,sets.bar.color = setcolors
)
dev.off()
```

