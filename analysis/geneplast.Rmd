---
title: "NCBI geneplast"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    df_print: paged
    highlight: espresso
    number_sections: yes
    theme: default
    toc: yes
    toc_depth: 2
    toc_float: yes
---
# Objetivo
Obter os enraizamentos
```{r message=FALSE}
library(tidyverse)
library(magrittr)
library(geneplast)
library(ape)

library(XML)
library(rentrez)
```

# Dados
Carregamos o arquivo gerados no notebook anterior
```{r rows.print=5}
data(
  cogs,
  neurotransmission_cogs,
  string_eukaryotes,
  package = "neurotransmission"
)

cogs %<>% rename(protein_id = string_id, ssp_id = taxid) %>% select(protein_id, ssp_id, cog_id)
```

# Arvore
Gerando objeto phytool da arvore curada
```{r rows.print=5}
# carregando newick
phyloTree <- read.tree("../inst/extdata/hybrid_tree.nwk")

# renomeando tip.alias com base no match entre ssp_ids
phyloTree[["tip.alias"]] <- string_eukaryotes[["string_name"]][match(phyloTree[["tip.label"]], string_eukaryotes[["taxid"]])]
```

# Geneplast
## Raizes
```{r message=F, warning=F, include=FALSE, quiet=T}
ogr <- groot.preprocess(
  cogdata   = cogs,
  phyloTree = phyloTree,
  spid      = "9606",
  cogids    = neurotransmission_cogs %>% pull(cog_id) %>% unique
)

ogp <- gplast.preprocess(
  cogdata   = cogs,
  cogids    = neurotransmission_cogs %>% pull(cog_id) %>% unique
)

ogr <- groot(ogr, nPermutations=1)
```

```{r rows.print=5}
roots <- groot.get(ogr, what="results") %>%
  rownames_to_column("cog_id") %>%
  select(cog_id, Root) %>%
  rename(root = Root)

# write_tsv(roots, "../inst/extdata/cogs_roots.tsv")
```

# extant clades' names
```{r}
lineages <- entrez_fetch(
  db = "taxonomy",
  id = string_eukaryotes[["new_taxid"]],
  rettype = "xml",
  retmode = "xml",
  parsed=TRUE
)

string_eukaryotes %<>% mutate(
  root = ogr@tree$tip.group[taxid],
  lineage_txt = xpathSApply(lineages, "//Lineage", XML::xmlValue)
)

all_equal <- function(...) {
  Reduce(identical, list(...))
}

a <- string_eukaryotes %>%
  mutate(lineage_list = strsplit(lineage_txt, "; ")) %>%
  group_by(root) %>%
  summarise(group_depth  = map_int(lineage_list, length) %>% min)

pmap(strsplit(string_eukaryotes$lineage_txt, "; "), ~ {
  length(unique(.)) == 1
})

roots_names <- string_eukaryotes %>%
  group_by(root) %>%
  summarise(lineage = Reduce(intersect, strsplit(lineage_txt, "; ")) %>% list) %>%
  mutate(clade_name = mapply(setdiff,    lineage, lead(lineage))) %>%
  mutate(clade_name = mapply(setdiff, clade_name,  lag(lineage))) %>%
  mutate(clade_name = map_chr(clade_name, 1, .default = NA)) %>%
  mutate(clade_name = coalesce(clade_name, root %>% as.character, clade_name)) #%>%
  # select(root, clade_name)

# write_tsv(roots_extant_clades, "extant_clades.tsv")
```

# plotting all patterns
```{r}
groot.plot(ogr, plot.lcas = TRUE, width=10, height=20, cex.lab = 0.2, cex.nodes = 0.4)

for (i in roots$cog_id) {
  groot.plot(
    ogr, 
    whichOG = i, 
    width=10, 
    height=20, 
    cex.lab = 0.2, 
    cex.nodes = 0.4
  )
}
```

